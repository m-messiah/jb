# URL Shortener

Сервис по сокращению ссылок.

## Приложение

Простая обертка на flask для key-value хранилища, где ключ - base64 от uuid4, а значение - введенный url.

+ / - форма ввода
+ / POST url - сохранить url по ключу и вернуть короткий url
+ /code - перенаправить на сохраненный урл, если code существует

## Инфраструктура

### Приложение

Состоит из двух ролей:

+ redis
+ uwsgi/shortener

На каждой ноде есть свой redis, реплицирующий мастера и состоящий в кластере sentinel.

Приложение запущено под uwsgi с http протоколом, и при подключении к redis спрашивает sentinel где мастер.

При падении мастера sentinel перевыбирает нового и перенастраивает репликацию.

TODO: можно разделить redis и приложение по разным контейнерам, но тогда менее ясно, на какой sentinel идти спрашивать мастера (необходимо поддерживать топологию). В такой конфигурации же, приожение всегда спрашивает локального sentinel, что, при возникновении проблем, позволяет пометить всю ноду как неработоспособную.

### Балансировщик

В качестве балансировщика используется nginx с proxy_next_upstream и списком всех бэкендов в качестве апстрима.

Таким образом, если какая-то из нод отвечает не так, как требуется (или не отвечает), nginx идет спрашивать следущую.

Балансировка самого nginx предполагается средствами DNS round-robin, однако в данном конкретном случае DNS сервер отсутствует, поэтому и сценария для его настройки нет. 

## Деплой

Деплой всего сразу осуществляется ansible:

    cd deploy
    ansible-playbook deploy.yml -e domain_name=example.com

При каких либо изменениях конфигураций осуществляется перезапуск redis/uwsgi/nginx (в соответствии с тем, что менялось), после чего - всегда проверка, работает ли POST на сайте.

Деплой осуществляется сначала на одну первую ноду в списке `inventory.cfg`, после чего, если не было ошибок, - на все остальные, что позволяет избежать падения всей инфраструктуры при неправильной конфигурации, а также, избежать даунтайма за счет разделения параллелизма. (при увеличении числа нод, видимо, потребуется увеличить разбиение).

Предложенные сценарии тестировались на Debian, однако должны быть совместимы и с rpm-based дистрибутивами.

## Тест

Для теста количества запросов в секунду приложен скрипт запуска ab, который параллельно добавляет все новые и новые урлы.

## Масштабируемость

За счет схемы, в которой redis стоит на той же ноде, что и приложение, сервис легко масштабируется простым добавлением нового адреса в `inventory.cfg` (на машину должен быть доступ по ssh)

